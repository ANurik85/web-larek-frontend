# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом
- src/components/common/ — папка с общий кодом

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или
```

yarn build
```

## Данные и типи данных

Интерфейс карточка товара

```
interface ICard {
  id: string;
  description: string;
  title: string;
  category: string;
  price: number;
  image: string;
}
```

Интерфейс карточка товара в корзину

```
export interface IProduct {
  price?: number;
  id: string;
  title: string;
  index?: string;
}
```

Данные для формы:
Данные форма для заполнение полей e-email и телефон

```
interface IFormContacts {
  email: string;
  phone: string;
}
```

Интерфейс для выбора сопособ оплаты и добавление адреса

```
interface IFormAddress {
  address: string;
  paymentMethod: string;

}
```

Интерфейс массив строк, представляющий элементы заказа.

```
interface IOrder {
  items: string[]
}
```

Данные для отображение текст ошибки валидности поля формы

```
type FormErrors = Partial<Record<keyof (IFormAddress & IFormContacts), string>>;
```

Интерфейс определяет структуру результата заказа

```
interface IOrderResult extends IFormAddress, IFormContacts, IOrder  {
  total: number;
}
```

Интерфейс описывает структуру данных карточек и методы для работы с ними.

Interface ICardsData:

- `catalog: ICard[]` - Массив строк, представляющий карточки.
- `preview: string | null` - Строка или null, представляющая предварительный просмотр.
- `loading: boolean` - Массив объектов карточек.

- `сardId: string` - Свойства для получения идентификатор карточки.
- `getCardItem(шd: string): ICard` - Метод для получения карточки по её идентификатору.
- `setCatalog(items: ICard[]): void` - Метод для предпросмотра карточек.
- `setPreview(item: ICard[]): void` - Метод для добавления карточки в корзину.

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP:

- **слой данных, отвечает за хранение и изменение данных,**
- **слой представления, отвечает за отображение данных на странице,**
- **презентер, отвечает за связь представления и данных.**

### Базовый код

#### Класс Api

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы:

- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.

Основные методы, реализуемые классом описаны интерфейсом `IEvents`:

- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие

#### Класс Model

Абстрактный класс Model, Это базовый класс, который нельзя инстанцировать напрямую. Он предназначен для наследования другими классами.

- Конструктор: Принимает частичные данные типа T и объект events, который реализует интерфейс `IEvents`.
- Данные присваиваются экземпляру класса с помощью `Object.assign`.
- Метод `emitChanges`: Этот метод уведомляет всех подписчиков о том, что модель изменилась, вызывая метод emit у объекта events.

_Функция isModel: Это TypeScript гарда (type guard), которая проверяет, является ли объект экземпляром класса Model._

### Слой данных

#### Класс CardsData

Класс CardsData наследуется от `Model` и управляет данными карточек, корзиной и заказами.

- `catalog: ICard[]` - Каталог карточек.
- `_preview: string | null` - id карточки, выбранной для просмотра в модальной окне
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

- Конструктор инициализирует объект `CardsData` с начальными значениями и событиями.

Так же класс предоставляет набор методов для взаимодействия с этими данными:

- `getCardItem()` - получаем список карточек.

- `setCatalog(items: ILot[])` - Устанавливает каталог

- `setPreview(item: ICard)` - Устанавливает превью карточки.

- `get cards(): ICard[]` - Возвращает массив карточек из каталога.

### Классы представления

Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Базовый Класс Component

Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

#### Класс Form

Класс `Form` представляет собой компонент формы, который управляет элементами формы и обрабатывает события ввода и отправки.
Конструктор класса принимает инстант брокера событий\

В полях класса хранятся следующие данные:

- `tempOrderData: Partial<T> = {}` - Для временного хранения данных поля ввода.

- `protected _submit: HTMLButtonElement` - Элемент кнопки отправки.

- `protected _errors: HTMLElement` - Элемент для отображения ошибок формы.

Методы:

- `onInputChange` Обрабатывает изменения ввода, сохраняет данные во временное хранилище и генерирует событие.
- `set valid` Включает или отключает кнопку отправки в зависимости от валидности формы.
- `set errors` Устанавливает сообщения об ошибках в форме.
- `render` Отображает форму с заданным состоянием.

#### Класс Modal

Класс наследует Component и реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.

- Конструктор принимает контейнер и объект событий. Инициализирует кнопки закрытия и контент модального окна.
- События добавляет обработчики событий для закрытия модального окна.

Поля класса:

- `_closeButton: HTMLButtonElement` - Кнопка закрытие и подтверждения
- `_content: HTMLElement` Для отображение контента

Методы:

- Сеттер `content` Обновляет содержимое модального окна.
- `open` Открывает модальное окно и вызывает событие modal:open.
- `close` Закрывает модальное окно, очищает содержимое и вызывает событие modal:close.
- `render` Обновляет данные компонента и открывает модальное окно.

#### Класс Card

Отвечает за отображение карточки, класс `Card` представляет собой компонент, который используется для отображения карточки с информацией. Он включает в себя элементы заголовка, категории, цены, изображения и описания. Класс используется для отображения карточrb товара на странице сайта. В конструктор класса передается DOM элемент темплейта, что позволяет при необходимости формировать карточки разных вариантов верстки. В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователя генерируются соответствующие события.\

Поля класса содержат элементы разметки элементов карточки:

- `protected _title: HTMLElement` - элемент заголовка карточки.
- `protected _category: HTMLElement` - элемент категории карточки.
- `protected _price: HTMLElement` - элемент цены карточки.
- `protected _image?: HTMLImageElement` - элемент изображения карточки (необязательно).
- `protected _description?: HTMLElement` - элемент описания карточки (необязательно).
- `protected _button: HTMLButtonElement` - элемент для кнопка добавление карточки в корзине.

Конструктор, кроме темплейта принимает экземпляр `EventEmitter` для инициации событий.\

Методы:

- `set id(value: string)` - Устанавливает идентификатор карточки.
- `get id(): string` - Возвращает идентификатор карточки.
- `set title(value: string)` - Устанавливает заголовок карточки.
- `get title(): string` - Возвращает заголовок карточки.
- `set image(value: string)` - Устанавливает изображение карточки.
- `set price(value: string)` - Устанавливает цена карточки.
- `get price(): string` - Возвращает цена карточки.
- `set category(value: string)` - Устанавливает категории карточки.
- `get category(): string` - Возвращает категории карточки.
- `set description(value: string | string[])` - Устанавливает описание карточки. Может принимать строку или массив строк.
- `render(data: Partial<ICard>): HTMLElement` - Отображает карточку с заданными данными.

#### Класс BasketItemView

Класс `BasketItemView` представляет собой компонент, который отображает отдельный товар в корзине. Он отвечает за отрисовку и управление отображением отдельного товара в корзине.

- Конструктор класса `BasketItemView` принимает два параметра: container и events. Параметр container представляет собой HTML-элемент, который является контейнером для отображения товара. Параметр events является экземпляром класса EventEmitter, который используется для обработки событий.

Поля класса:

- `title` HTML-элемент, который представляет собой заголовок товара.
- `indexNumber` HTML-элемент для отображение индекс товара в корзину.
- `removeButton` HTML-элемент кнопки для удаления товара из корзины.
- `id` Строка или значение null, которое представляет собой идентификатор товара.

Методы:

- `getId(): string | null` Метод для получения значения id.

- `getElement(): HTMLElement` Метод для получения элемента.

- `setIndexNumber(number: number)` Метод для установки порядкового номера.

- `render(data?: object)` Этот метод отвечает за отрисовку отображения товара на основе переданных данных. Он обновляет заголовок товара и возвращает контейнерный элемент с обновленным отображением.

#### Класс BasketView

Этот класс `BasketView` реализует интерфейс `IView` и представляет собой отображение корзины товаров.

- `constructor(protected container: HTMLElement)` Конструктор класса, который принимает контейнер HTML-элемента (HTMLElement) и сохраняет его как защищенное свойство (protected container).

Методы:

- `setTotal(total: number)` - Устанавливает значение свойства _total в виде форматированного числа.

- `calculateTotal(): number` - Рассчитывает общую стоимость всех карточек в корзине.

- `updateTotal()` - Обновляет общую стоимость в корзине.

- `render(data: { items: HTMLElement[] })` Метод отрисовки корзины, который принимает данные в виде объекта с массивом HTML-элементов (items). Если данные переданы, метод заменяет содержимое контейнера на переданные элементы. Метод возвращает контейнер HTML-элемента.

#### Класс BasketModel

Класс BasketModel представляет собой модель корзины покупателя, которая позволяет добавлять, удалять и управлять товарами в корзине. Класс BasketModel реализует интерфейс IBasketModel. Объект EventEmitter используется для отправки событий, когда корзина изменяется.

Свойства класса:

`items:` карта (Map) для хранения товаров в корзине, где ключом является идентификатор товара (string), а значением - количество товара (number).

- `basket: IProduct[]` - Массив представляющий корзину.

- `constructor(protected events: EventEmitter)` - Конструктор класса, который принимает объект EventEmitter для отправки событий, когда корзина изменяется.

Методы:

- `addToBasket(cardId: IProduct): void` - Метод добавление карточек в корзине.

- `removeCard(cardId: string)` - удаляет карточки из корзину.

- `clearBasket(): void` - очищает карточки из корзину.

- `getItems()` - Возвращает массив объектов, содержащих идентификатор и количество каждого товара в корзине.

- `updateItemCount()` - обновляет отображение количества карточек в корзине.

#### Класс BasketCatalogModel

Класс `BasketCatalogModel` представляет собой модель каталога товаров. Он реализует интерфейс `ICatalogModel`. Этот класс предназначен для организации и управления списком товаров в каталоге. Он позволяет устанавливать и получать список товаров, а также осуществлять поиск товара по его идентификатору.

Поля:

- `catalog: IProduct[]` - Массив, хранящий список товаров в каталоге.

Методы:

- `setItems(items: IProduct[]): void` - Метод, который устанавливает список товаров в каталог, принимая массив объектов IProduct в качестве параметра.

- `getProduct(id: string): IProduct` - Метод, который возвращает товар из каталога по его идентификатору (id).

- `getTotal(): number` - Метод, который возвращает общие стоимость товара из каталога.

#### Класс OrderAddress

Класс расширяет компонент Form и предназначен для реализации модального окна с формой содержащей поля ввода. При сабмите инициирует событие передавая в него объект с данными из полей ввода формы. При изменении данные в поле ввода инициирует событие изменения данных.

Поля класса:

- `_button` элемент HTML, представляющий кнопку закрытия.
- `_paymentMethod` список кнопок для выбора метода оплаты.
- `order: IFormAddress` - Объект типа IFormAddress с двумя свойствами: paymentMethod и address.
- `formErrors: FormErrors = {};` -  содержит ошибки в форме.

- `constructor(container: HTMLFormElement, events: IEvents)` Конструктор класса, который принимает контейнер HTML-элемента и объект событий. Он находит кнопку заказа и добавляет слушатель события клика, который отправляет событие order:open.

Методы:

- Метод `set address` устанавливает значение поля ввода адреса.
- `_paymentMethod` - Определяет кнопку, вызвавшую событие. Удаляет класс selected у всех кнопок. Добавляет класс selected к выбранной кнопке. Устанавливает значение поля ввода paymentMethod в соответствии с именем выбранной кнопки.

- `setOrderField(field: keyof IFormAddress, value: string):` Устанавливает значение поля заказа и проверяет валидность заказа. Если заказ валиден, отправляет событие order:ready.

- `validateOrder():` Проверяет валидность заказа, возвращает true если заказ валиден, иначе false. Отправляет событие formErrors:change с ошибками валидации.

#### Класс Order

Расширяет класс Form. Предназначен для реализации модального окна с формой содержащей поля ввода. При сабмите инициирует событие передавая в него объект с данными из полей ввода формы. При изменении данных в поля ввода инициирует событие изменения данных. Предоставляет методы для отображения ошибок и управления активностью кнопки сохранения.\

Поля:

- `order: IFormContacts` - Объект типа IFormContacts с двумя свойствами `_phone` и `_email`  используются для хранения ссылок на соответствующие элементы формы.
- `formErrors: FormErrors = {};` -  содержит ошибки в форме.

- `constructor(container: HTMLFormElement, events: IEvents)` Конструктор класса, который принимает контейнер HTML-элемента и объект событий.

Методы:

- Cеттеры:`set phone`, `set email` устанавливают значения полей phone и email в форме, используя метод namedItem для поиска элементов по имени.

- `setOrderField(field: keyof IFormContacts, value: string):` Устанавливает значение поля заказа и проверяет валидность заказа. Если заказ валиден, отправляет событие.

- `validateOrder():` Проверяет валидность заказа, возвращает true если заказ валиден, иначе false. Отправляет событие formErrors:change с ошибками валидации.

#### Класс Page

Класс `Page` наследуется от `Component<IPage>` и используется для управления элементами страницы, такими как каталог и корзина.

Свойства:

- `_catalog: HTMLElement;` - элемент каталога. Хранит ссылку на HTML-элемент, представляющий содержимое каталога.
- `_counter: HTMLElement` - элемент для показа количество товара в корзину.
- `_wrapper: HTMLElement` - свойство для блокировки прокрутки страницу.
- `_basket: HTMLElement` - свойство для кнопка корзина на главная страницу.

Конструктор

- `constructor(container: HTMLElement, protected events: IEvents)` - Конструктор принимает контейнер и события в качестве параметров. Он инициализирует элементы каталога и корзины, а также добавляет обработчик событий для корзины.

Методы:

- `set catalog(items: HTMLElement[])` - Метод для обновления содержимого каталога. Метод catalog заменяет все дочерние элементы элемента каталога новыми элементами из массива items.

- `set counter(value: number)` - Метод для установление количество содержимого корзину.

- `set locked(value: boolean)` - Метод позволяет блокировать или разблокировать страницу, добавляя или удаляя соответствующий класс.

#### Класс Success

Расширяет класс Component. Предназначен для реализации модального окна успешное оформление. В модального окна отображается текст "Заказ оформлен" и общая сумма заказа.

Поля класса:

- `_close: HTMLButtonElement` - Кнопка закрытие и подтверждения
- `_total: HTMLElement` - Для отображение общая сумма заказа
- метод сеттер `set total`, который обновляет текстовое содержимое HTML-элемента \_total новым значением общей суммы. Метод использует регулярное выражение \d+ для совпадения с одной или несколькими цифрами в текущем текстовом содержимом и замены его новым значением общей суммы.

### Слой коммуникации

#### Класс AppApi

Класс `AppApi` расширяет класс `Api` и реализует интерфейс `IAPI`. Этот класс предназначен для взаимодействия с API и предоставляет методы для получения информации о карточках товаров и оформления заказов.

Методы:

- `getCardItem` - Получает информацию о карточке товара по его идентификатору.
- `getCardList` - Получает список всех карточек товаров.
- `orderCards` - Оформляет заказ на карточки товаров.

## Взаимодействие компонентов

Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

_Список всех событий, которые могут генерироваться в системе:_\
_События изменения данных (генерируются классами моделями данных)_

- `items:changed` - событие обновление содержимое каталога.
- `basket:change` - событие обновление содержимое корзину
- `formErrors:change` - событие обновляет состояние валидации объектов
- `modal:open` - событие блокировка прокрутку страницы если открыта модалка
- `modal:close` - событие разблокировка прокрутку страницы если закрыта модалка

_События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)._

- `card:select` - выбор товара для отображения в модальном окне.
- `order:submit` - событие, генерируемое при нажатии "Оплатить" в форме контакты
- `order:change`, `contacts:change` - событие обрабатывает изменения полей заказа.
- `address:open` - событие, при нажатии "В корзину" в модального окна превью карточки
- `order:open` - событие, генерируемое при нажатии "Далее" в форме выбор оплати и адресс
- `basket:add` - добавить товар в корзину
- `basket:remove` - удалить товар в корзину
- `basket:open` - открытие модального окна корзину
- `success:submit` - событие, при нажатии "За новыми покупками!" в форме о подтверждение успешной покупки
